{"version":3,"file":"elsa-dropdown-property.entry.esm.js","sources":["src/components/editors/properties/elsa-dropdown-property/elsa-dropdown-property.tsx"],"sourcesContent":["import { Component, h, Prop, State } from '@stencil/core';\r\nimport { ActivityDefinitionProperty, ActivityModel, ActivityPropertyDescriptor, RuntimeSelectListProviderSettings, SelectList, SyntaxNames } from \"../../../../models\";\r\nimport Tunnel from \"../../../../data/workflow-editor\";\r\nimport { getSelectListItems } from \"../../../../utils/select-list-items\";\r\nimport { awaitElement } from \"../../../../utils/utils\";\r\n\r\n@Component({\r\n  tag: 'elsa-dropdown-property',\r\n  shadow: false,\r\n})\r\nexport class ElsaDropdownProperty {\r\n\r\n  @Prop() activityModel: ActivityModel;\r\n  @Prop() propertyDescriptor: ActivityPropertyDescriptor;\r\n  @Prop() propertyModel: ActivityDefinitionProperty;\r\n  @Prop({ mutable: true }) serverUrl: string;\r\n  @State() currentValue?: string;\r\n\r\n  selectList: SelectList = { items: [], isFlagsEnum: false };\r\n\r\n  async componentWillLoad() {\r\n    const defaultSyntax = this.propertyDescriptor.defaultSyntax || SyntaxNames.Literal;\r\n    this.currentValue = this.propertyModel.expressions[defaultSyntax] || undefined;\r\n    const dependsOnEvent = this.propertyDescriptor.options && \"context\" in this.propertyDescriptor.options ? this.propertyDescriptor.options?.context?.dependsOnEvent : undefined;\r\n\r\n    // Does this property have a dependency on another property?\r\n    if (!!dependsOnEvent) {\r\n\r\n      // Collect current property values of the activity.\r\n      const initialDepsValue = {};\r\n\r\n      for (const event of dependsOnEvent) {\r\n        for (const value of this.activityModel.properties) {\r\n          initialDepsValue[value.name] = value.expressions['Literal'];\r\n        }\r\n\r\n        // Listen for change events on the dependency dropdown list.\r\n        const dependentInputElement: HTMLSelectElement = await awaitElement('#' + event);\r\n        dependentInputElement.addEventListener('change', this.reloadSelectListFromDeps);\r\n\r\n        // Get the current value of the dependency dropdown list.\r\n        initialDepsValue[event] = dependentInputElement.value;\r\n      }\r\n\r\n      const existingOptions = this.propertyDescriptor.options as RuntimeSelectListProviderSettings;\r\n      // Load the list items from the backend.\r\n      const options: RuntimeSelectListProviderSettings = {\r\n        context: {\r\n          ...existingOptions.context,\r\n          depValues: initialDepsValue\r\n        },\r\n        runtimeSelectListProviderType: existingOptions.runtimeSelectListProviderType\r\n\r\n      };\r\n      this.selectList = await getSelectListItems(this.serverUrl, { options: options } as ActivityPropertyDescriptor);\r\n\r\n      if (this.currentValue == undefined) {\r\n        const defaultValue = this.propertyDescriptor.defaultValue;\r\n        if(defaultValue) {\r\n          this.currentValue = defaultValue;\r\n        }\r\n        else {\r\n          const firstOption: any = this.selectList.items[0];\r\n\r\n          if (firstOption) {\r\n            const optionIsObject = typeof (firstOption) == 'object';\r\n            this.currentValue = optionIsObject ? firstOption.value : firstOption.toString();\r\n          }\r\n        }\r\n      }\r\n\r\n    } else {\r\n      this.selectList = await getSelectListItems(this.serverUrl, this.propertyDescriptor);\r\n\r\n      if (this.currentValue == undefined) {\r\n        const defaultValue = this.propertyDescriptor.defaultValue;\r\n        if(defaultValue) {\r\n          this.currentValue = defaultValue;\r\n        }\r\n        else {\r\n          const firstOption: any = this.selectList.items[0];\r\n\r\n          if (firstOption) {\r\n            const optionIsObject = typeof (firstOption) == 'object';\r\n            this.currentValue = optionIsObject ? firstOption.value : firstOption.toString();\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    if (this.currentValue != undefined) {\r\n      this.propertyModel.expressions[defaultSyntax] = this.currentValue;\r\n    }\r\n  }\r\n\r\n  private reloadSelectListFromDeps = async (e: InputEvent) => {\r\n    const depValues = {};\r\n    const options = this.propertyDescriptor.options as RuntimeSelectListProviderSettings;\r\n\r\n    for (const dependencyPropName of options.context.dependsOnValue) {\r\n      const value = this.activityModel.properties.find((prop) => {\r\n        return prop.name == dependencyPropName;\r\n      });\r\n      depValues[dependencyPropName] = value.expressions[\"Literal\"];\r\n    }\r\n\r\n    // Need to get the latest value of the component that just changed.\r\n    // For this we need to get the value from the event.\r\n    const currentTarget = e.currentTarget as HTMLSelectElement;\r\n    depValues[currentTarget.id] = currentTarget.value;\r\n\r\n    let newOptions: RuntimeSelectListProviderSettings = {\r\n      context: {\r\n        ...options.context,\r\n        depValues: depValues\r\n      },\r\n      runtimeSelectListProviderType: options.runtimeSelectListProviderType\r\n    }\r\n\r\n    this.selectList = await getSelectListItems(this.serverUrl, { options: newOptions } as ActivityPropertyDescriptor);\r\n\r\n    \r\n    \r\n    let currentSelectList = await awaitElement('#' + this.propertyDescriptor.name);\r\n\r\n    const defaultValue = this.propertyDescriptor.defaultValue;\r\n    if(defaultValue) {\r\n      this.currentValue = defaultValue;\r\n    }\r\n    else {\r\n      const firstOption: any = this.selectList.items[0];\r\n      if (firstOption) {\r\n        const optionIsObject = typeof (firstOption) == 'object';\r\n        this.currentValue = optionIsObject ? firstOption.value : firstOption.toString();\r\n      }\r\n    }\r\n\r\n    // Dispatch change event so that dependent dropdown elements refresh.\r\n    // Do this after the current component has re-rendered, otherwise the current value will be sent to the backend, which is outdated.\r\n    requestAnimationFrame(() => {\r\n      currentSelectList.dispatchEvent(new Event(\"change\"));\r\n    });\r\n  }\r\n\r\n  private onChange(e: Event) {\r\n    const select = (e.target as HTMLSelectElement);\r\n    const defaultSyntax = this.propertyDescriptor.defaultSyntax || SyntaxNames.Literal;\r\n    this.propertyModel.expressions[defaultSyntax] = this.currentValue = select.value;\r\n  }\r\n\r\n  private onDefaultSyntaxValueChanged(e: CustomEvent) {\r\n    this.currentValue = e.detail;\r\n  }\r\n\r\n  render() {\r\n    const propertyDescriptor = this.propertyDescriptor;\r\n    const propertyModel = this.propertyModel;\r\n    const propertyName = propertyDescriptor.name;\r\n    const fieldId = propertyName;\r\n    const fieldName = propertyName;\r\n    let currentValue = this.currentValue;\r\n    const { items } = this.selectList;\r\n\r\n    if (currentValue == undefined) {\r\n      const defaultValue = this.propertyDescriptor.defaultValue;\r\n      currentValue = defaultValue ? defaultValue.toString() : undefined;\r\n    }\r\n\r\n    return (\r\n      <elsa-property-editor\r\n        activityModel={this.activityModel}\r\n        propertyDescriptor={propertyDescriptor}\r\n        propertyModel={propertyModel}\r\n        onDefaultSyntaxValueChanged={e => this.onDefaultSyntaxValueChanged(e)}\r\n        single-line={true}>\r\n        <select id={fieldId}\r\n          name={fieldName}\r\n          onChange={e => this.onChange(e)}\r\n          class=\"elsa-mt-1 elsa-block focus:elsa-ring-blue-500 focus:elsa-border-blue-500 elsa-w-full elsa-shadow-sm sm:elsa-max-w-xs sm:elsa-text-sm elsa-border-gray-300 elsa-rounded-md\">\r\n          {items.map(item => {\r\n            const optionIsObject = typeof (item) == 'object';\r\n            const value = optionIsObject ? item.value : item.toString();\r\n            const text = optionIsObject ? item.text : item.toString();\r\n            return <option value={value} selected={value === currentValue}>{text}</option>;\r\n          })}\r\n        </select>\r\n      </elsa-property-editor>\r\n    );\r\n  }\r\n}\r\n\r\nTunnel.injectProps(ElsaDropdownProperty, ['serverUrl']);\r\n"],"names":[],"mappings":"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"}