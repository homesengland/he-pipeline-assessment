{"version":3,"file":"elsa-script-property.entry.esm.js","sources":["src/components/editors/properties/elsa-script-property/elsa-script-property.tsx"],"sourcesContent":["import {Component, h, Prop, State} from '@stencil/core';\r\nimport {\r\n  ActivityDefinitionProperty,\r\n  ActivityPropertyDescriptor,\r\n  ActivityValidatingContext,\r\n  ConfigureComponentCustomButtonContext,\r\n  ComponentCustomButtonClickContext,\r\n  EventTypes, ActivityModel, IntellisenseContext\r\n} from \"../../../../models\";\r\nimport {createElsaClient, eventBus} from \"../../../../services\";\r\nimport Tunnel from '../../../../data/workflow-editor';\r\nimport {MonacoValueChangedArgs} from \"../../../controls/elsa-monaco/elsa-monaco\";\r\n\r\n@Component({\r\n  tag: 'elsa-script-property',\r\n  shadow: false,\r\n})\r\nexport class ElsaScriptProperty {\r\n\r\n  @Prop() activityModel: ActivityModel;\r\n  @Prop() propertyDescriptor: ActivityPropertyDescriptor;\r\n  @Prop() propertyModel: ActivityDefinitionProperty;\r\n  @Prop({attribute: 'editor-height', reflect: true}) editorHeight: string = '6em';\r\n  @Prop({attribute: 'single-line', reflect: true}) singleLineMode: boolean = false;\r\n  @Prop() syntax?: string;\r\n  @Prop({mutable: true}) serverUrl: string;\r\n  @Prop({mutable: true}) workflowDefinitionId: string;\r\n  @State() currentValue?: string;\r\n\r\n  monacoEditor: HTMLElsaMonacoElement;\r\n  activityValidatingContext: ActivityValidatingContext = null;\r\n  configureComponentCustomButtonContext: ConfigureComponentCustomButtonContext = null;\r\n\r\n  async componentWillLoad() {\r\n    this.currentValue = this.propertyModel.expressions['Literal'];\r\n    await this.configureComponentCustomButton();\r\n    this.validate(this.currentValue);\r\n  }\r\n\r\n  async componentDidLoad() {\r\n    const elsaClient = await createElsaClient(this.serverUrl);\r\n    const context: IntellisenseContext = {\r\n      propertyName: this.propertyDescriptor.name,\r\n      activityTypeName: this.activityModel.type\r\n    };\r\n    const libSource = await elsaClient.scriptingApi.getJavaScriptTypeDefinitions(this.workflowDefinitionId, context);\r\n    const libUri = 'defaultLib:lib.es6.d.ts';\r\n    await this.monacoEditor.addJavaScriptLib(libSource, libUri);\r\n  }\r\n\r\n  async configureComponentCustomButton() {\r\n    this.configureComponentCustomButtonContext = {\r\n      component: 'elsa-script-property',\r\n      activityType: this.activityModel.type,\r\n      prop: this.propertyDescriptor.name,\r\n      data: null\r\n    };\r\n    await eventBus.emit(EventTypes.ComponentLoadingCustomButton, this, this.configureComponentCustomButtonContext);\r\n  }\r\n\r\n  mapSyntaxToLanguage(syntax: string): any {\r\n    switch (syntax) {\r\n      case 'JavaScript':\r\n        return 'javascript';\r\n      case 'Liquid':\r\n        return 'handlebars';\r\n      case 'Literal':\r\n      default:\r\n        return 'plaintext';\r\n    }\r\n  }\r\n\r\n  onComponentCustomButtonClick(e: Event) {\r\n    e.preventDefault();\r\n    const componentCustomButtonClickContext: ComponentCustomButtonClickContext = {\r\n      component: 'elsa-script-property',\r\n      activityType: this.activityModel.type,\r\n      prop: this.propertyDescriptor.name,\r\n      params: null\r\n    };\r\n    eventBus.emit(EventTypes.ComponentCustomButtonClick, this, componentCustomButtonClickContext);\r\n  }\r\n\r\n  onMonacoValueChanged(e: MonacoValueChangedArgs) {\r\n    this.currentValue = e.value;\r\n    this.validate(this.currentValue);\r\n  }\r\n\r\n  validate(value: string) {\r\n    this.activityValidatingContext = {\r\n      activityType: this.activityModel.type,\r\n      prop: this.propertyDescriptor.name,\r\n      value: value,\r\n      data: null,\r\n      isValidated: false,\r\n      isValid: false\r\n    };\r\n    eventBus.emit(EventTypes.ActivityPluginValidating, this, this.activityValidatingContext);\r\n  }\r\n\r\n  render() {\r\n    const propertyDescriptor = this.propertyDescriptor;\r\n    const syntax = this.syntax;\r\n    const monacoLanguage = this.mapSyntaxToLanguage(syntax);\r\n    const propertyName = propertyDescriptor.name;\r\n    const fieldId = propertyName;\r\n    const fieldName = propertyName;\r\n    const fieldLabel = propertyDescriptor.label || propertyName;\r\n    const fieldHint = propertyDescriptor.hint;\r\n    const value = this.currentValue;\r\n\r\n    const renderValidationResult = () => {\r\n      if (this.activityValidatingContext == null || !this.activityValidatingContext.isValidated)\r\n        return;\r\n\r\n      const isPositiveResult = this.activityValidatingContext.isValid;\r\n      const color = isPositiveResult ? 'green' : 'red';\r\n\r\n      return (\r\n        <div class=\"elsa-mt-3\">\r\n          <p class={`elsa-mt-1 elsa-text-sm elsa-text-${color}-500`}>\r\n            {this.activityValidatingContext.data}\r\n          </p>\r\n        </div>\r\n      )\r\n    }\r\n\r\n    const renderComponentCustomButton = () => {\r\n      if (this.configureComponentCustomButtonContext.data == null)\r\n        return;\r\n\r\n      const label = this.configureComponentCustomButtonContext.data.label;\r\n\r\n      return (\r\n        <div class=\"elsa-mt-3\">\r\n          <a href=\"#\"\r\n             onClick={e => this.onComponentCustomButtonClick(e)}\r\n             class=\"elsa-relative elsa-inline-flex elsa-items-center elsa-px-4 elsa-py-2 elsa-border elsa-border-gray-300 elsa-text-sm elsa-leading-5 elsa-font-medium elsa-rounded-md elsa-text-gray-700 elsa-bg-white hover:elsa-text-gray-500 focus:elsa-outline-none focus:elsa-shadow-outline-blue focus:elsa-border-blue-300 active:elsa-bg-gray-100 active:elsa-text-gray-700 elsa-transition elsa-ease-in-out elsa-duration-150\">\r\n            {label}\r\n          </a>\r\n        </div>\r\n      )\r\n    }\r\n\r\n    return <div>\r\n\r\n      <div class=\"elsa-flex\">\r\n        <div class=\"\">\r\n          <label htmlFor={fieldId} class=\"elsa-block elsa-text-sm elsa-font-medium elsa-text-gray-700\">\r\n            {fieldLabel}\r\n          </label>\r\n        </div>\r\n        <div class=\"elsa-flex-1\">\r\n          <div>\r\n            <div class=\"hidden sm:elsa-block\">\r\n              <nav class=\"elsa-flex elsa-flex-row-reverse\" aria-label=\"Tabs\">\r\n                <span\r\n                  class=\"elsa-bg-blue-100 elsa-text-blue-700 elsa-px-3 elsa-py-2 elsa-font-medium elsa-text-sm elsa-rounded-md\">\r\n                  {syntax}\r\n                </span>\r\n              </nav>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n      <div class=\"elsa-mt-1\">\r\n        <elsa-monaco value={value}\r\n                     language={monacoLanguage}\r\n                     editor-height={this.editorHeight}\r\n                     single-line={this.singleLineMode}\r\n                     onValueChanged={e => this.onMonacoValueChanged(e.detail)}\r\n                     ref={el => this.monacoEditor = el}/>\r\n      </div>\r\n      {fieldHint ? <p class=\"elsa-mt-2 elsa-text-sm elsa-text-gray-500\">{fieldHint}</p> : undefined}\r\n      <input type=\"hidden\" name={fieldName} value={value}/>\r\n      {renderValidationResult()}\r\n      {renderComponentCustomButton()}\r\n    </div>\r\n  }\r\n}\r\n\r\nTunnel.injectProps(ElsaScriptProperty, ['serverUrl', 'workflowDefinitionId']);\r\n"],"names":[],"mappings":"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"}