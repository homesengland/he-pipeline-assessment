{"version":3,"file":"elsa-workflow-blueprint-viewer-screen.entry.esm.js","sources":["src/components/screens/workflow-blueprint-viewer/elsa-workflow-blueprint-viewer-screen/elsa-workflow-blueprint-viewer-screen.tsx"],"sourcesContent":["import {Component, h, Host, Method, Prop, State, Watch} from '@stencil/core';\r\nimport * as collection from 'lodash/collection';\r\nimport {\r\n  ActivityBlueprint, ActivityDefinitionProperty,\r\n  ActivityDescriptor,\r\n  ActivityModel, Connection,\r\n  ConnectionModel,\r\n  SyntaxNames,\r\n  WorkflowBlueprint, WorkflowModel,\r\n  WorkflowPersistenceBehavior\r\n} from \"../../../../models\";\r\nimport {createElsaClient} from \"../../../../services\";\r\nimport state from '../../../../utils/store';\r\nimport {WorkflowDesignerMode} from \"../../../designers/tree/elsa-designer-tree/models\";\r\nimport Tunnel from \"../../../../data/dashboard\";\r\n\r\n@Component({\r\n  tag: 'elsa-workflow-blueprint-viewer-screen',\r\n  shadow: false,\r\n})\r\nexport class ElsaWorkflowBlueprintViewerScreen {\r\n\r\n  @Prop() workflowDefinitionId: string;\r\n  @Prop() serverUrl: string;\r\n  @Prop() culture: string;\r\n  @State() workflowBlueprint: WorkflowBlueprint;\r\n  @State() workflowModel: WorkflowModel;\r\n  el: HTMLElement;\r\n  designer: HTMLElsaDesignerTreeElement;\r\n\r\n  @Method()\r\n  async getServerUrl(): Promise<string> {\r\n    return this.serverUrl;\r\n  }\r\n\r\n  @Watch('workflowDefinitionId')\r\n  async workflowDefinitionIdChangedHandler(newValue: string) {\r\n    const workflowDefinitionId = newValue;\r\n    let workflowBlueprint: WorkflowBlueprint = {\r\n      id: null,\r\n      version: 1,\r\n      activities: [],\r\n      connections: [],\r\n      persistenceBehavior: WorkflowPersistenceBehavior.WorkflowBurst,\r\n      customAttributes: {data: {}},\r\n      persistWorkflow: false,\r\n      isLatest: false,\r\n      isPublished: false,\r\n      loadWorkflowContext: false,\r\n      isSingleton: false,\r\n      saveWorkflowContext: false,\r\n      variables: {data: {}},\r\n      type: null,\r\n      inputProperties: {data: {}},\r\n      outputProperties: {data: {}},\r\n      propertyStorageProviders: {}\r\n    };\r\n\r\n    const client = await createElsaClient(this.serverUrl);\r\n\r\n    if (workflowDefinitionId && workflowDefinitionId.length > 0) {\r\n      try {\r\n        workflowBlueprint = await client.workflowRegistryApi.get(workflowDefinitionId, {isLatest: true});\r\n      } catch {\r\n        console.warn(`The specified workflow blueprint does not exist. Creating a new one.`);\r\n      }\r\n    }\r\n\r\n    this.updateModels(workflowBlueprint);\r\n  }\r\n\r\n  @Watch(\"serverUrl\")\r\n  async serverUrlChangedHandler(newValue: string) {\r\n    if (newValue && newValue.length > 0)\r\n      await this.loadActivityDescriptors();\r\n  }\r\n\r\n  async componentWillLoad() {\r\n    await this.serverUrlChangedHandler(this.serverUrl);\r\n    await this.workflowDefinitionIdChangedHandler(this.workflowDefinitionId);\r\n  }\r\n\r\n  componentDidLoad() {\r\n    if (!this.designer) {\r\n      if (state.useX6Graphs) {\r\n        this.designer = this.el.querySelector(\"x6-designer\") as HTMLX6DesignerElement;\r\n      } else {\r\n        this.designer = this.el.querySelector('elsa-designer-tree') as HTMLElsaDesignerTreeElement;\r\n      }\r\n      this.designer.model = this.workflowModel;\r\n    }\r\n  }\r\n\r\n  async loadActivityDescriptors() {\r\n    const client = await createElsaClient(this.serverUrl);\r\n    state.activityDescriptors = await client.activitiesApi.list();\r\n  }\r\n\r\n  updateModels(workflowBlueprint: WorkflowBlueprint) {\r\n    this.workflowBlueprint = workflowBlueprint;\r\n    this.workflowModel = this.mapWorkflowModel(workflowBlueprint);\r\n  }\r\n\r\n  mapWorkflowModel(workflowBlueprint: WorkflowBlueprint): WorkflowModel {\r\n    return {\r\n      activities: workflowBlueprint.activities.filter(x => x.parentId == workflowBlueprint.id || !x.parentId).map(this.mapActivityModel),\r\n      connections: workflowBlueprint.connections.map(this.mapConnectionModel),\r\n      persistenceBehavior: workflowBlueprint.persistenceBehavior,\r\n    };\r\n  }\r\n\r\n  mapActivityModel(source: ActivityBlueprint): ActivityModel {\r\n    const activityDescriptors: Array<ActivityDescriptor> = state.activityDescriptors;\r\n    const activityDescriptor = activityDescriptors.find(x => x.type == source.type);\r\n    const properties: Array<ActivityDefinitionProperty> = collection.map(source.inputProperties.data, (value, key) => {\r\n      const propertyDescriptor = activityDescriptor.inputProperties.find(x => x.name == key);\r\n      const defaultSyntax = propertyDescriptor?.defaultSyntax || SyntaxNames.Literal;\r\n      const expressions = {};\r\n      expressions[defaultSyntax] = value;\r\n      return ({name: key, expressions: expressions, syntax: defaultSyntax});\r\n    });\r\n\r\n    return {\r\n      activityId: source.id,\r\n      description: source.description,\r\n      displayName: source.displayName || source.name || source.type,\r\n      name: source.name,\r\n      type: source.type,\r\n      x: source.x,\r\n      y: source.y,\r\n      properties: properties,\r\n      outcomes: [...activityDescriptor.outcomes],\r\n      persistWorkflow: source.persistWorkflow,\r\n      saveWorkflowContext: source.saveWorkflowContext,\r\n      loadWorkflowContext: source.loadWorkflowContext,\r\n      propertyStorageProviders: source.propertyStorageProviders,\r\n    }\r\n  }\r\n\r\n  mapConnectionModel(connection: Connection): ConnectionModel {\r\n    return {\r\n      sourceId: connection.sourceActivityId,\r\n      targetId: connection.targetActivityId,\r\n      outcome: connection.outcome\r\n    }\r\n  }\r\n\r\n  render() {\r\n    return (\r\n      <Host class=\"elsa-flex elsa-flex-col elsa-w-full elsa-relative\" ref={el => this.el = el}>\r\n        {this.renderCanvas()}\r\n      </Host>\r\n    );\r\n  }\r\n\r\n  renderCanvas() {\r\n    return (\r\n      <div class=\"elsa-flex-1 elsa-flex\">\r\n        {!state.useX6Graphs && (\r\n          <elsa-designer-tree\r\n            model={this.workflowModel}\r\n            class=\"elsa-flex-1\"\r\n            ref={el => this.designer = el}\r\n            mode={WorkflowDesignerMode.Blueprint}\r\n          />\r\n        )}\r\n        {state.useX6Graphs && (\r\n          <x6-designer\r\n            model={this.workflowModel}\r\n            class=\"elsa-workflow-wrapper\"\r\n            ref={el => this.designer = el}\r\n            mode={WorkflowDesignerMode.Blueprint}\r\n          />\r\n        )}\r\n        <elsa-flyout-panel>\r\n          <elsa-tab-header tab=\"general\" slot=\"header\">General</elsa-tab-header>\r\n          <elsa-tab-content tab=\"general\" slot=\"content\">\r\n            <elsa-workflow-blueprint-properties-panel workflowId={this.workflowDefinitionId}/>\r\n          </elsa-tab-content>\r\n        </elsa-flyout-panel>\r\n      </div>\r\n    );\r\n  }\r\n}\r\n\r\nTunnel.injectProps(ElsaWorkflowBlueprintViewerScreen, ['serverUrl', 'culture']);\r\n"],"names":["collection.map"],"mappings":"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"}